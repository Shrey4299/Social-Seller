<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Razorpay Web-Integration</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <hr />
    <h1>List of Unpaid Orders</h1>
    <ul>
      <% orders.forEach(order => { %> <% if (!order.isPaid) { %>
      <li>
        <strong>Order ID:</strong> <%= order.id %><br />
        <strong>Amount:</strong> Rs. <%= order.price %><br />
        <strong>Address:</strong> <%= order.address %><br />
        <strong>Description:</strong> <%= order.slug %><br />
        <strong>Order Variants:</strong><br />
        <ul>
          <% orderVariants.forEach(orderVariant => { %> <% if
          (orderVariant.OrderId === order.id) { %>
          <li>
            Variant ID: <%= orderVariant.VariantId %><br />
            Quantity: <%= orderVariant.quantity %><br />
            Price: <%= orderVariant.price %><br />
          </li>
          <% } %> <% }); %>
        </ul>
        <form class="pay-form">
          <input type="hidden" name="name" value="Product" />
          <input type="hidden" name="amount" value="<%= order.price %>" />
          <input type="hidden" name="mainId" value="<%= order.id %>" />
          <input type="hidden" name="description" value="Product Desc" />
          <input type="submit" value="Pay Now" />
        </form>
      </li>
      <% } %> <% }); %>
    </ul>
    <div style="display: inline-block"></div>
  </body>
</html>

<!--Inside index.html -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  $(document).ready(function () {
    $(".pay-form").submit(function (e) {
      e.preventDefault();

      var formData = $(this).serialize();

      console.log("this is form data" + formData);

      axios
        .post("/api/createOrder", formData)
        .then(function (response) {
          var res = response.data;

          if (res.success) {
            var options = {
              key: "" + res.key_id + "",
              amount: "" + res.amount + "",
              currency: "INR",
              name: "" + res.product_name + "",
              description: "" + res.description + "",
              image: "https://dummyimage.com/600x400/000/fff",
              order_id: "" + res.order_id + "",
              mainId: "" + res.mainId + "",
              handler: function (response) {
                console.log(JSON.stringify(response));
                console.log(response.razorpay_order_id);
                console.log(response.razorpay_payment_id);
                console.log(response.razorpay_signature);
                console.log(res.mainId);

                // Make a request for payment verification
                axios
                  .post("/api/verifyPayment", {
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    order_id: res.mainId,
                  })
                  .then(function (response) {
                    console.log(response);
                    alert("Payment Succeeded");
                  })
                  .catch(function (error) {
                    console.log(error);
                    alert("Payment Verification Failed");
                  });
              },
              prefill: {
                contact: "" + res.contact + "",
                name: "" + res.name + "",
                email: "" + res.email + "",
              },
              notes: {
                description: "" + res.description + "",
              },
              theme: {
                color: "#2300a3",
              },
            };
            var razorpayObject = new Razorpay(options);
            razorpayObject.on("payment.failed", function (response) {
              alert("Payment Failed");
            });
            razorpayObject.open();
          } else {
            alert(res.msg);
          }
        })
        .catch(function (error) {
          console.log(error);
        });
    });
  });
</script>
